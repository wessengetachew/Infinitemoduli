
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular Arithmetic Grid Explorer - Interactive Visualization</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        h1 {
            color: #2d3748;
            font-size: 2.2em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #718096;
            font-size: 1.1em;
        }
        
        .author {
            color: #4a5568;
            margin-top: 10px;
            font-style: italic;
        }
        
        .controls-section {
            background: #f7fafc;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }
        
        .control-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .control-group {
            flex: 1;
            min-width: 200px;
        }
        
        .control-group label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: #cbd5e0;
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .value-display {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 700;
            min-width: 50px;
            text-align: center;
        }
        
        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: white;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .radio-option:hover {
            border-color: #667eea;
            background: #edf2f7;
        }
        
        .radio-option input[type="radio"] {
            cursor: pointer;
        }
        
        .radio-option input[type="radio"]:checked + span {
            color: #667eea;
            font-weight: 700;
        }
        
        .canvas-container {
            background: #1a202c;
            padding: 30px;
            border-radius: 12px;
            margin: 30px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }
        
        canvas {
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .info-panels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .info-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .info-panel h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            padding-bottom: 10px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .info-label {
            font-weight: 500;
        }
        
        .info-value {
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }
        
        .structure-panel {
            background: #edf2f7;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
        }
        
        .structure-panel h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .structure-item {
            padding: 10px 0;
            color: #4a5568;
            line-height: 1.6;
        }
        
        .special-elements {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .element-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            text-align: center;
        }
        
        .element-card .title {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .element-card .value {
            font-size: 1.5em;
            font-weight: 700;
            color: #2d3748;
        }
        
        .element-card .count {
            color: #718096;
            font-size: 0.85em;
            margin-top: 5px;
        }
        
        .explanation-section {
            background: #fffbeb;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid #f59e0b;
        }
        
        .explanation-section h3 {
            color: #92400e;
            margin-bottom: 15px;
        }
        
        .explanation-section p {
            color: #78350f;
            line-height: 1.7;
            margin-bottom: 10px;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 20px 0;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 2px solid #2d3748;
        }
        
        .export-section {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
            color: #718096;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Modular Arithmetic Grid Explorer</h1>
            <div class="subtitle">Interactive Visualization of Multiplication and Addition Tables in ℤ/mℤ</div>
            <div class="author">by Wessen Getachew</div>
        </header>

        <div class="controls-section">
            <h2 style="margin-bottom: 20px; color: #2d3748;">Configuration</h2>
            
            <div class="control-row">
                <div class="control-group" style="flex: 2;">
                    <label>Famous Sequence Presets:</label>
                    <div class="radio-group" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <button onclick="applyPreset('basel')" style="background: #8b5cf6; padding: 8px 12px; font-size: 0.9em;">
                            ζ(2) = π²/6 (m=6)
                        </button>
                        <button onclick="applyPreset('totient12')" style="background: #8b5cf6; padding: 8px 12px; font-size: 0.9em;">
                            φ(12) = 4 (m=12)
                        </button>
                        <button onclick="applyPreset('prime')" style="background: #8b5cf6; padding: 8px 12px; font-size: 0.9em;">
                            Prime Field (m=17)
                        </button>
                        <button onclick="applyPreset('highly_composite')" style="background: #8b5cf6; padding: 8px 12px; font-size: 0.9em;">
                            Highly Composite (m=60)
                        </button>
                        <button onclick="applyPreset('power_of_2')" style="background: #8b5cf6; padding: 8px 12px; font-size: 0.9em;">
                            Power of 2 (m=32)
                        </button>
                        <button onclick="applyPreset('fibonacci')" style="background: #8b5cf6; padding: 8px 12px; font-size: 0.9em;">
                            Fibonacci (m=89)
                        </button>
                        <button onclick="applyPreset('mersenne')" style="background: #8b5cf6; padding: 8px 12px; font-size: 0.9em;">
                            Mersenne (m=31)
                        </button>
                        <button onclick="applyPreset('perfect')" style="background: #8b5cf6; padding: 8px 12px; font-size: 0.9em;">
                            Perfect Number (m=28)
                        </button>
                        <button onclick="applyPreset('euler_constant')" style="background: #8b5cf6; padding: 8px 12px; font-size: 0.9em;">
                            Euler's e (m≈271)
                        </button>
                        <button onclick="applyPreset('golden_ratio')" style="background: #8b5cf6; padding: 8px 12px; font-size: 0.9em;">
                            Golden Ratio (m≈161)
                        </button>
                        <button onclick="applyPreset('ramanujan')" style="background: #8b5cf6; padding: 8px 12px; font-size: 0.9em;">
                            Ramanujan τ (m=24)
                        </button>
                        <button onclick="applyPreset('catalan')" style="background: #8b5cf6; padding: 8px 12px; font-size: 0.9em;">
                            Catalan (m=42)
                        </button>
                        <button onclick="applyPreset('coprime_density')" style="background: #8b5cf6; padding: 8px 12px; font-size: 0.9em;">
                            6/π² Density (m=61)
                        </button>
                        <button onclick="applyPreset('harmonic')" style="background: #8b5cf6; padding: 8px 12px; font-size: 0.9em;">
                            Harmonic (m=100)
                        </button>
                        <button onclick="applyPreset('twin_primes')" style="background: #8b5cf6; padding: 8px 12px; font-size: 0.9em;">
                            Twin Primes (m=71,73)
                        </button>
                    </div>
                </div>
            </div>

            <div class="control-row" style="background: #e0f2fe; padding: 15px; border-radius: 8px; border-left: 4px solid #0284c7;">
                <div style="width: 100%;">
                    <h4 style="margin: 0 0 8px 0; color: #0c4a6e;">Current Preset Info</h4>
                    <div id="presetInfo" style="color: #0c4a6e; font-size: 0.95em; line-height: 1.5;">
                        Select a preset above to explore famous mathematical sequences and constants through modular arithmetic.
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="control-group">
                    <label>Modulus (m): <span class="value-display" id="modulusDisplay">12</span></label>
                    <input type="range" id="modulusSlider" min="2" max="100" value="12" oninput="updateModulus()">
                    <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #718096; margin-top: 5px;">
                        <span>2</span>
                        <span>100</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Or enter directly:</label>
                    <input type="number" id="modulusInput" min="2" max="5000" value="12" onchange="updateModulusFromInput()">
                    <div style="font-size: 0.85em; color: #718096; margin-top: 5px;">
                        Max: 5000 (use quality controls for large values)
                    </div>
                </div>
            </div>
            
            <div id="performanceInfo" style="background: #e0f2fe; padding: 12px; border-radius: 6px; margin-top: 15px; color: #0c4a6e; font-size: 0.9em; text-align: center;">
                Current Grid: 12×12 = 144 cells | Cell size: 100px | Quality: Auto
            </div>

            <div class="control-row">
                <div class="control-group">
                    <label>Table Type:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="tableType" value="multiplication" checked onchange="updateVisualization()">
                            <span>Multiplication (× mod m)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="tableType" value="cayley" onchange="updateVisualization()">
                            <span>Units Only (Cayley)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="tableType" value="addition" onchange="updateVisualization()">
                            <span>Addition (+ mod m)</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="control-group">
                    <label>Color Scheme:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="colorScheme" value="rainbow" checked onchange="updateVisualization()">
                            <span>Rainbow (by value)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="colorScheme" value="residueClass" onchange="updateVisualization()">
                            <span>By Residue Class</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="colorScheme" value="divisibility" onchange="updateVisualization()">
                            <span>By Divisibility</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="colorScheme" value="zeroDivisors" onchange="updateVisualization()">
                            <span>Highlight Zero Divisors</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="colorScheme" value="idempotents" onchange="updateVisualization()">
                            <span>Highlight Idempotents</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="control-group">
                    <label>Cell Labels:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="labelType" value="result" checked onchange="updateVisualization()">
                            <span>Show Result</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="labelType" value="coordinates" onchange="updateVisualization()">
                            <span>Show (a,b)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="labelType" value="operation" onchange="updateVisualization()">
                            <span>Show a⊗b</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="labelType" value="properties" onchange="updateVisualization()">
                            <span>Show Properties</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="labelType" value="gcd" onchange="updateVisualization()">
                            <span>Show gcd(a,b)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="labelType" value="none" onchange="updateVisualization()">
                            <span>No Labels</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="control-group">
                    <label>Label Color Style:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="labelColor" value="white" checked onchange="updateVisualization()">
                            <span>White</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="labelColor" value="black" onchange="updateVisualization()">
                            <span>Black</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="labelColor" value="contrast" onchange="updateVisualization()">
                            <span>Auto Contrast</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="labelColor" value="byType" onchange="updateVisualization()">
                            <span>By Element Type</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="control-group">
                    <label>Grid Axis Labels:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="checkbox" id="showRowLabels" checked onchange="updateVisualization()">
                            <span>Show Row Labels</span>
                        </label>
                        <label class="radio-option">
                            <input type="checkbox" id="showColLabels" checked onchange="updateVisualization()">
                            <span>Show Column Labels</span>
                        </label>
                        <label class="radio-option">
                            <input type="checkbox" id="showGridLines" onchange="updateVisualization()">
                            <span>Show Grid Lines</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="control-row">
                <div class="control-group">
                    <label>Font Size: <span class="value-display" id="fontSizeDisplay">Auto</span></label>
                    <input type="range" id="fontSizeSlider" min="0" max="40" value="0" oninput="updateFontSize()">
                    <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #718096; margin-top: 5px;">
                        <span>Auto</span>
                        <span>40px</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="gridCanvas" width="1200" height="1200"></canvas>
        </div>

        <div class="controls-section" style="background: #fff3cd; border: 2px solid #ffc107;">
            <h3 style="color: #856404; margin-bottom: 15px;">Performance & Quality Controls</h3>
            
            <div class="control-row">
                <div class="control-group">
                    <label>Canvas Resolution: <span class="value-display" id="resolutionDisplay">1200px</span></label>
                    <input type="range" id="resolutionSlider" min="800" max="2400" value="1200" step="200" oninput="updateCanvasResolution()">
                    <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #718096; margin-top: 5px;">
                        <span>800px</span>
                        <span>2400px (4K-ready)</span>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Rendering Quality:</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="quality" value="adaptive" checked onchange="updateVisualization()">
                            <span>Adaptive (Auto)</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="quality" value="high" onchange="updateVisualization()">
                            <span>High Quality</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="quality" value="fast" onchange="updateVisualization()">
                            <span>Fast (Large m)</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="control-row">
                <div class="control-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="antialiasing" checked onchange="updateVisualization()">
                        <span>Enable Antialiasing (smoother text)</span>
                    </label>
                </div>
                <div class="control-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="highDPI" checked onchange="updateVisualization()">
                        <span>High DPI Rendering (retina displays)</span>
                    </label>
                </div>
            </div>
            
            <div style="background: #fff; padding: 15px; border-radius: 6px; margin-top: 15px;">
                <div style="font-weight: 600; color: #856404; margin-bottom: 8px;">Performance Tips:</div>
                <ul style="margin-left: 20px; color: #856404; font-size: 0.9em; line-height: 1.6;">
                    <li><strong>m > 100:</strong> Use "Fast" quality or disable labels for better performance</li>
                    <li><strong>m > 200:</strong> Consider "No Labels" mode and increase canvas resolution</li>
                    <li><strong>Export:</strong> Always use "High Quality" before exporting for publications</li>
                    <li><strong>Zoom:</strong> Increase canvas resolution to see fine details in large grids</li>
                </ul>
            </div>
        </div>

        <div class="export-section">
            <button onclick="exportCanvas()">Export as 4K PNG</button>
            <button onclick="exportData()">Export Data as CSV</button>
        </div>

        <div class="legend" id="legendSection" style="display: none;">
            <h3 style="width: 100%; text-align: center; margin-bottom: 15px; color: #2d3748;">Color Legend</h3>
            <div id="legendContent" style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;"></div>
        </div>

        <div class="info-panels">
            <div class="info-panel">
                <h3>Grid Statistics</h3>
                <div class="info-item">
                    <span class="info-label">Modulus:</span>
                    <span class="info-value" id="statModulus">12</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Total Elements:</span>
                    <span class="info-value" id="statTotal">144</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Unique Values:</span>
                    <span class="info-value" id="statUnique">12</span>
                </div>
            </div>

            <div class="info-panel">
                <h3>Ring Properties</h3>
                <div class="info-item">
                    <span class="info-label">φ(m) - Euler Totient:</span>
                    <span class="info-value" id="statPhi">4</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Is Integral Domain:</span>
                    <span class="info-value" id="statIntegral">NO</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Is Field:</span>
                    <span class="info-value" id="statField">NO</span>
                </div>
            </div>
        </div>

        <div class="structure-panel">
            <h3>Structure Analysis</h3>
            <div id="structureContent"></div>
        </div>

        <div class="special-elements" id="specialElements">
            <div class="element-card">
                <div class="title">UNITS</div>
                <div class="value" id="unitsCount">4</div>
                <div class="count" id="unitsList">{1, 5, 7, 11}</div>
            </div>
            <div class="element-card">
                <div class="title">ZERO DIVISORS</div>
                <div class="value" id="zeroDivisorsCount">7</div>
                <div class="count" id="zeroDivisorsList">{2, 3, 4, 6, 8, 9, 10}</div>
            </div>
            <div class="element-card">
                <div class="title">IDEMPOTENTS</div>
                <div class="value" id="idempotentsCount">4</div>
                <div class="count" id="idempotentsList">{0, 1, 4, 9}</div>
            </div>
            <div class="element-card">
                <div class="title">NILPOTENTS</div>
                <div class="value" id="nilpotentsCount">0</div>
                <div class="count" id="nilpotentsList">{}</div>
            </div>
        </div>

        <div class="explanation-section">
            <h3>Understanding the Grid</h3>
            <div id="explanationContent"></div>
        </div>

        <footer>
            <p>Interactive Mathematical Visualization Tool</p>
            <p style="margin-top: 10px;">Wessen Getachew | <a href="https://github.com/wessengetachew" style="color: #667eea;">GitHub</a> | <a href="https://twitter.com/7dview" style="color: #667eea;">@7dview</a></p>
        </footer>
    </div>

    <script>
        // Mathematical utilities
        function gcd(a, b) {
            a = Math.abs(a);
            b = Math.abs(b);
            while (b !== 0) {
                let t = b;
                b = a % b;
                a = t;
            }
            return a;
        }

        function euler_phi(n) {
            if (n === 1) return 1;
            let result = n;
            let p = 2;
            let temp = n;
            while (p * p <= temp) {
                if (temp % p === 0) {
                    while (temp % p === 0) temp /= p;
                    result -= result / p;
                }
                p++;
            }
            if (temp > 1) result -= result / temp;
            return Math.round(result);
        }

        function isPrime(n) {
            if (n < 2) return false;
            if (n === 2) return true;
            if (n % 2 === 0) return false;
            for (let i = 3; i * i <= n; i += 2) {
                if (n % i === 0) return false;
            }
            return true;
        }

        function isSquareFree(n) {
            let p = 2;
            while (p * p <= n) {
                if (n % (p * p) === 0) return false;
                p++;
            }
            return true;
        }

        // Find units (invertible elements)
        function findUnits(m) {
            const units = [];
            for (let a = 1; a < m; a++) {
                if (gcd(a, m) === 1) units.push(a);
            }
            return units;
        }

        // Find zero divisors
        function findZeroDivisors(m) {
            const zeroDivisors = new Set();
            for (let a = 1; a < m; a++) {
                for (let b = 1; b < m; b++) {
                    if ((a * b) % m === 0) {
                        zeroDivisors.add(a);
                        zeroDivisors.add(b);
                    }
                }
            }
            return Array.from(zeroDivisors).sort((a, b) => a - b);
        }

        // Find idempotents
        function findIdempotents(m) {
            const idempotents = [];
            for (let a = 0; a < m; a++) {
                if ((a * a) % m === a) idempotents.push(a);
            }
            return idempotents;
        }

        // Find nilpotents
        function findNilpotents(m) {
            const nilpotents = [];
            for (let a = 0; a < m; a++) {
                let power = a;
                let isNilpotent = false;
                for (let k = 1; k <= 20; k++) {
                    if (power % m === 0 && k > 1) {
                        isNilpotent = true;
                        break;
                    }
                    power = (power * a) % m;
                }
                if (isNilpotent && a !== 0) nilpotents.push(a);
            }
            return nilpotents;
        }

        // Color schemes
        function getRainbowColor(value, m) {
            const hue = (value / m) * 360;
            return `hsl(${hue}, 80%, 60%)`;
        }

        function getResidueClassColor(value, m) {
            const classes = [
                '#e74c3c', '#3498db', '#2ecc71', '#f39c12',
                '#9b59b6', '#1abc9c', '#e67e22', '#34495e',
                '#95a5a6', '#c0392b', '#2980b9', '#27ae60'
            ];
            return classes[value % classes.length];
        }

        function getDivisibilityColor(value, m) {
            if (value === 0) return '#34495e';
            const divisors = [];
            for (let d = 2; d <= m; d++) {
                if (value % d === 0) divisors.push(d);
            }
            if (divisors.length === 0) return '#2ecc71'; // No divisors (relatively prime)
            const hue = 240 - (divisors.length / m) * 180;
            return `hsl(${hue}, 70%, 55%)`;
        }

        function getZeroDivisorColor(value, m, zeroDivisors) {
            if (value === 0) return '#2c3e50';
            return zeroDivisors.includes(value) ? '#e74c3c' : '#3498db';
        }

        function getIdempotentColor(value, m, idempotents) {
            if (value === 0) return '#2c3e50';
            return idempotents.includes(value) ? '#f39c12' : '#95a5a6';
        }

        // Preset configurations
        function applyPreset(presetName) {
            let m, tableType, colorScheme, labelType;
            
            switch(presetName) {
                case 'basel':
                    // Basel problem: ζ(2) = π²/6, related to coprime probability
                    m = 6;
                    tableType = 'multiplication';
                    colorScheme = 'zeroDivisors';
                    labelType = 'result';
                    showInfo('Basel Problem (ζ(2))', 'Modulus 6: Related to Euler\'s Basel problem. The probability that two random integers are coprime is 6/π² ≈ 0.6079. φ(6) = 2.');
                    break;
                    
                case 'totient12':
                    // Classic example with φ(12) = 4
                    m = 12;
                    tableType = 'cayley';
                    colorScheme = 'rainbow';
                    labelType = 'result';
                    showInfo('φ(12) = 4', 'The group of units (ℤ/12ℤ)× has 4 elements: {1, 5, 7, 11}. This is the classic coprime density example.');
                    break;
                    
                case 'prime':
                    // Prime field - integral domain
                    m = 17;
                    tableType = 'multiplication';
                    colorScheme = 'rainbow';
                    labelType = 'result';
                    showInfo('Prime Field ℤ/17ℤ', 'A prime modulus creates a field. Every non-zero element is a unit. φ(17) = 16. No zero divisors.');
                    break;
                    
                case 'highly_composite':
                    // Highly composite number with many divisors
                    m = 60;
                    tableType = 'multiplication';
                    colorScheme = 'divisibility';
                    labelType = 'result';
                    showInfo('Highly Composite: 60', '60 = 2²×3×5 has many divisors. φ(60) = 16. Rich algebraic structure with many zero divisors.');
                    break;
                    
                case 'power_of_2':
                    // Power of 2 - special structure
                    m = 32;
                    tableType = 'multiplication';
                    colorScheme = 'idempotents';
                    labelType = 'result';
                    showInfo('Power of 2: m=32', '32 = 2⁵. φ(32) = 16. Half the elements are units. Special structure in powers of 2.');
                    break;
                    
                case 'fibonacci':
                    // Fibonacci prime
                    m = 89;
                    tableType = 'cayley';
                    colorScheme = 'rainbow';
                    labelType = 'result';
                    showInfo('Fibonacci Prime: F₁₁ = 89', '89 is the 11th Fibonacci number and a prime. Forms a field. φ(89) = 88.');
                    break;
                    
                case 'mersenne':
                    // Mersenne prime
                    m = 31;
                    tableType = 'multiplication';
                    colorScheme = 'rainbow';
                    labelType = 'result';
                    showInfo('Mersenne Prime: 2⁵-1 = 31', '31 = 2⁵ - 1 is a Mersenne prime. Forms a field. φ(31) = 30.');
                    break;
                    
                case 'perfect':
                    // Perfect number
                    m = 28;
                    tableType = 'multiplication';
                    colorScheme = 'divisibility';
                    labelType = 'result';
                    showInfo('Perfect Number: 28', '28 = 1+2+4+7+14 is the 2nd perfect number. 28 = 2²×7. φ(28) = 12.');
                    break;
                    
                case 'euler_constant':
                    // Related to e ≈ 2.718...
                    m = 271; // e×100 ≈ 271
                    tableType = 'cayley';
                    colorScheme = 'rainbow';
                    labelType = 'result';
                    showInfo('Euler\'s e: m≈271', '271 is prime and ≈100e. Forms a field with φ(271) = 270 units.');
                    break;
                    
                case 'golden_ratio':
                    // Related to φ ≈ 1.618...
                    m = 161; // 100φ ≈ 161.8, but 161 = 7×23
                    tableType = 'multiplication';
                    colorScheme = 'zeroDivisors';
                    labelType = 'result';
                    showInfo('Golden Ratio: m≈161', '161 ≈ 100φ where φ = (1+√5)/2. 161 = 7×23 (semiprime). φ(161) = 132.');
                    break;
                    
                case 'ramanujan':
                    // Related to Ramanujan's tau function
                    m = 24;
                    tableType = 'multiplication';
                    colorScheme = 'divisibility';
                    labelType = 'result';
                    showInfo('Ramanujan τ: m=24', '24 appears in Ramanujan\'s tau function τ(n). 24 = 2³×3. φ(24) = 8. Related to modular forms.');
                    break;
                    
                case 'catalan':
                    // Related to Catalan's constant
                    m = 42; // Related to Catalan numbers
                    tableType = 'multiplication';
                    colorScheme = 'rainbow';
                    labelType = 'result';
                    showInfo('Catalan Numbers: m=42', '42 = 2×3×7 appears in Catalan number sequences. φ(42) = 12. Answer to everything!');
                    break;
                    
                case 'coprime_density':
                    // 6/π² ≈ 0.6079... → 61/100
                    m = 61;
                    tableType = 'multiplication';
                    colorScheme = 'zeroDivisors';
                    labelType = 'result';
                    showInfo('Coprime Density: 6/π²', '61 is prime. 61/100 ≈ 6/π² (coprime pair density). φ(61) = 60. Forms a field.');
                    break;
                    
                case 'harmonic':
                    // Harmonic series: 1/1 + 1/2 + 1/3 + ...
                    m = 100;
                    tableType = 'cayley';
                    colorScheme = 'rainbow';
                    labelType = 'result';
                    showInfo('Harmonic: m=100', '100 = 2²×5². φ(100) = 40. Visualizes unit structure. Related to harmonic analysis mod 100.');
                    break;
                    
                case 'twin_primes':
                    // Twin primes 71 and 73
                    m = 71;
                    tableType = 'multiplication';
                    colorScheme = 'rainbow';
                    labelType = 'result';
                    showInfo('Twin Primes: 71 & 73', '71 is prime (twin with 73). Both form fields. φ(71) = 70. Prime gaps and density.');
                    break;
            }
            
            // Apply settings
            document.getElementById('modulusInput').value = m;
            document.getElementById('modulusSlider').value = Math.min(m, 100);
            document.getElementById('modulusDisplay').textContent = Math.min(m, 100);
            
            // Set radio buttons
            document.querySelector(`input[name="tableType"][value="${tableType}"]`).checked = true;
            document.querySelector(`input[name="colorScheme"][value="${colorScheme}"]`).checked = true;
            document.querySelector(`input[name="labelType"][value="${labelType}"]`).checked = true;
            
            // Update preset info panel
            document.getElementById('presetInfo').innerHTML = `<strong>${title}:</strong> ${message}`;
            
            updateVisualization();
        }
        
        // Show info notification
        function showInfo(title, message) {
            const infoDiv = document.createElement('div');
            infoDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                max-width: 400px;
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
            `;
            infoDiv.innerHTML = `
                <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">${title}</h3>
                <p style="margin: 0; line-height: 1.5;">${message}</p>
            `;
            document.body.appendChild(infoDiv);
            
            setTimeout(() => {
                infoDiv.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => infoDiv.remove(), 300);
            }, 5000);
        }
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(400px); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Update functions
        function updateModulus() {
            const value = document.getElementById('modulusSlider').value;
            document.getElementById('modulusDisplay').textContent = value;
            document.getElementById('modulusInput').value = value;
            updateVisualization();
        }

        function updateModulusFromInput() {
            const value = parseInt(document.getElementById('modulusInput').value);
            if (value >= 2 && value <= 5000) {
                document.getElementById('modulusSlider').value = Math.min(value, 100);
                document.getElementById('modulusDisplay').textContent = Math.min(value, 100);
                
                // Warn about large values
                if (value > 500) {
                    showInfo('Large Modulus', `m=${value} will create ${value}×${value} = ${(value*value).toLocaleString()} cells. Consider using "Fast" quality mode or "No Labels" for better performance.`);
                }
                
                updateVisualization();
            } else {
                alert('Please enter a modulus between 2 and 5000');
            }
        }

        function updateFontSize() {
            const value = document.getElementById('fontSizeSlider').value;
            document.getElementById('fontSizeDisplay').textContent = value === '0' ? 'Auto' : value + 'px';
            updateVisualization();
        }

        function updateCanvasResolution() {
            const resolution = parseInt(document.getElementById('resolutionSlider').value);
            document.getElementById('resolutionDisplay').textContent = resolution + 'px';
            
            const canvas = document.getElementById('gridCanvas');
            canvas.width = resolution;
            canvas.height = resolution;
            
            updateVisualization();
        }

        // Main visualization with adaptive quality
        function updateVisualization() {
            const m = parseInt(document.getElementById('modulusInput').value);
            const tableType = document.querySelector('input[name="tableType"]:checked').value;
            const colorScheme = document.querySelector('input[name="colorScheme"]:checked').value;
            const labelType = document.querySelector('input[name="labelType"]:checked').value;
            const labelColor = document.querySelector('input[name="labelColor"]:checked').value;
            const showRowLabels = document.getElementById('showRowLabels').checked;
            const showColLabels = document.getElementById('showColLabels').checked;
            const showGridLines = document.getElementById('showGridLines').checked;
            const fontSizeOverride = parseInt(document.getElementById('fontSizeSlider').value);
            const quality = document.querySelector('input[name="quality"]:checked').value;
            const antialiasing = document.getElementById('antialiasing').checked;
            const highDPI = document.getElementById('highDPI').checked;

            const canvas = document.getElementById('gridCanvas');
            const ctx = canvas.getContext('2d', { alpha: false });
            
            // High DPI support
            const dpr = highDPI ? (window.devicePixelRatio || 1) : 1;
            const displayWidth = canvas.width;
            const displayHeight = canvas.height;
            
            if (highDPI && dpr > 1) {
                canvas.width = displayWidth * dpr;
                canvas.height = displayHeight * dpr;
                canvas.style.width = displayWidth + 'px';
                canvas.style.height = displayHeight + 'px';
                ctx.scale(dpr, dpr);
            } else {
                canvas.style.width = displayWidth + 'px';
                canvas.style.height = displayHeight + 'px';
            }
            
            // Antialiasing control
            ctx.imageSmoothingEnabled = antialiasing;
            ctx.imageSmoothingQuality = antialiasing ? 'high' : 'low';
            
            const size = tableType === 'cayley' ? euler_phi(m) : m;
            const labelMargin = (showRowLabels || showColLabels) ? 40 : 0;
            const gridSize = displayWidth - labelMargin;
            const cellSize = Math.floor(gridSize / size);
            
            // Adaptive font sizing based on quality and cell size
            let fontSize;
            if (fontSizeOverride === 0) {
                if (quality === 'adaptive') {
                    if (size <= 20) fontSize = Math.max(8, Math.min(20, cellSize / 2.5));
                    else if (size <= 50) fontSize = Math.max(6, Math.min(14, cellSize / 2.8));
                    else if (size <= 100) fontSize = Math.max(4, Math.min(10, cellSize / 3));
                    else fontSize = Math.max(3, Math.min(8, cellSize / 3.5));
                } else if (quality === 'high') {
                    fontSize = Math.max(6, Math.min(20, cellSize / 2.5));
                } else { // fast
                    fontSize = Math.max(4, Math.min(12, cellSize / 3));
                }
            } else {
                fontSize = fontSizeOverride;
            }
            
            const labelFontSize = Math.max(8, Math.min(16, cellSize / 2));

            ctx.clearRect(0, 0, displayWidth, displayHeight);
            
            // Set background
            ctx.fillStyle = '#1a202c';
            ctx.fillRect(0, 0, displayWidth, displayHeight);

            // Get special elements
            const units = findUnits(m);
            const zeroDivisors = findZeroDivisors(m);
            const idempotents = findIdempotents(m);
            const nilpotents = findNilpotents(m);

            // Determine which elements to show
            let elements = [];
            if (tableType === 'cayley') {
                elements = units;
            } else {
                elements = Array.from({ length: m }, (_, i) => i);
            }

            const offset = (showRowLabels || showColLabels) ? labelMargin : 0;

            // Draw labels with adaptive sampling for large grids
            const labelSample = quality === 'fast' && size > 100 ? Math.ceil(size / 50) : 1;
            
            if (showColLabels) {
                ctx.fillStyle = '#ffffff';
                ctx.font = `bold ${labelFontSize}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                for (let j = 0; j < elements.length; j += labelSample) {
                    ctx.fillText(elements[j], offset + j * cellSize + cellSize / 2, labelMargin / 2);
                }
            }

            if (showRowLabels) {
                ctx.fillStyle = '#ffffff';
                ctx.font = `bold ${labelFontSize}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                for (let i = 0; i < elements.length; i += labelSample) {
                    ctx.fillText(elements[i], labelMargin / 2, offset + i * cellSize + cellSize / 2);
                }
            }

            // Performance optimization: batch rendering for large grids
            const useBatchRendering = quality === 'fast' && size > 150;
            
            if (useBatchRendering) {
                // Fast path: render blocks without individual borders
                for (let i = 0; i < elements.length; i++) {
                    for (let j = 0; j < elements.length; j++) {
                        const a = elements[i];
                        const b = elements[j];
                        
                        let value;
                        if (tableType === 'addition') {
                            value = (a + b) % m;
                        } else {
                            value = (a * b) % m;
                        }

                        let color = getColor(value, colorScheme, m, zeroDivisors, idempotents);
                        
                        const x = offset + j * cellSize;
                        const y = offset + i * cellSize;

                        ctx.fillStyle = color;
                        ctx.fillRect(x, y, cellSize, cellSize);
                    }
                }
            } else {
                // High quality path: individual cells with optional grid lines and labels
                for (let i = 0; i < elements.length; i++) {
                    for (let j = 0; j < elements.length; j++) {
                        const a = elements[i];
                        const b = elements[j];
                        
                        let value;
                        if (tableType === 'addition') {
                            value = (a + b) % m;
                        } else {
                            value = (a * b) % m;
                        }

                        let color = getColor(value, colorScheme, m, zeroDivisors, idempotents);
                        
                        const x = offset + j * cellSize;
                        const y = offset + i * cellSize;

                        ctx.fillStyle = color;
                        ctx.fillRect(x, y, cellSize - 1, cellSize - 1);

                        if (showGridLines && cellSize > 3) {
                            ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
                            ctx.lineWidth = 0.5;
                            ctx.strokeRect(x, y, cellSize - 1, cellSize - 1);
                        }

                        // Draw labels only if cell is large enough
                        if (labelType !== 'none' && cellSize >= 4) {
                            let labelText = getLabelText(labelType, a, b, value, tableType, units, zeroDivisors, idempotents);
                            
                            if (labelText !== '') {
                                let textColor = getLabelColor(labelColor, value, color, units, zeroDivisors, idempotents);
                                
                                ctx.fillStyle = textColor;
                                ctx.font = `bold ${fontSize}px Arial`;
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                
                                // Text shadow for readability
                                if (antialiasing && labelColor !== 'black' && cellSize > 8) {
                                    ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                                    ctx.shadowBlur = 2;
                                    ctx.shadowOffsetX = 0.5;
                                    ctx.shadowOffsetY = 0.5;
                                }
                                
                                // Only draw text if it will be visible
                                if (fontSize >= 3) {
                                    ctx.fillText(labelText, x + cellSize / 2, y + cellSize / 2);
                                }
                                
                                ctx.shadowColor = 'transparent';
                                ctx.shadowBlur = 0;
                                ctx.shadowOffsetX = 0;
                                ctx.shadowOffsetY = 0;
                            }
                        }
                    }
                }
            }

            // Update statistics
            updateStatistics(m, units, zeroDivisors, idempotents, nilpotents, tableType);
            
            // Update legend
            updateLegend(colorScheme, labelType, labelColor, m, units, zeroDivisors, idempotents);
            
            // Update performance info
            updatePerformanceInfo(m, size, cellSize, quality);
        }

        // Helper function to get color (consolidated)
        function getColor(value, colorScheme, m, zeroDivisors, idempotents) {
            switch (colorScheme) {
                case 'rainbow': return getRainbowColor(value, m);
                case 'residueClass': return getResidueClassColor(value, m);
                case 'divisibility': return getDivisibilityColor(value, m);
                case 'zeroDivisors': return getZeroDivisorColor(value, m, zeroDivisors);
                case 'idempotents': return getIdempotentColor(value, m, idempotents);
                default: return getRainbowColor(value, m);
            }
        }

        // Helper function to get label text
        function getLabelText(labelType, a, b, value, tableType, units, zeroDivisors, idempotents) {
            switch (labelType) {
                case 'result':
                    return value.toString();
                case 'coordinates':
                    return `(${a},${b})`;
                case 'operation':
                    const op = tableType === 'addition' ? '+' : '×';
                    return `${a}${op}${b}`;
                case 'properties':
                    if (units.includes(value)) return 'U';
                    if (zeroDivisors.includes(value)) return 'Z';
                    if (idempotents.includes(value)) return 'I';
                    if (value === 0) return '0';
                    return value.toString();
                case 'gcd':
                    return gcd(a, b).toString();
                case 'none':
                    return '';
                default:
                    return value.toString();
            }
        }

        // Helper function to get label color
        function getLabelColor(labelColor, value, bgColor, units, zeroDivisors, idempotents) {
            switch (labelColor) {
                case 'white': return '#ffffff';
                case 'black': return '#000000';
                case 'contrast': return getContrastColor(bgColor);
                case 'byType':
                    if (units.includes(value)) return '#00ff00';
                    if (zeroDivisors.includes(value)) return '#ff0000';
                    if (idempotents.includes(value)) return '#ffff00';
                    return '#ffffff';
                default: return '#ffffff';
            }
        }

        // Performance info display
        function updatePerformanceInfo(m, size, cellSize, quality) {
            const info = document.getElementById('performanceInfo');
            if (!info) return;
            
            const totalCells = size * size;
            const qualityLevel = quality === 'adaptive' ? 'Auto' : quality.charAt(0).toUpperCase() + quality.slice(1);
            
            info.innerHTML = `
                <strong>Current Grid:</strong> ${size}×${size} = ${totalCells.toLocaleString()} cells | 
                Cell size: ${cellSize}px | 
                Quality: ${qualityLevel}
            `;
        }

        // Update legend based on current settings
        function updateLegend(colorScheme, labelType, labelColor, m, units, zeroDivisors, idempotents) {
            const legendSection = document.getElementById('legendSection');
            const legendContent = document.getElementById('legendContent');
            
            let legendHTML = '';
            
            // Color scheme legend
            if (colorScheme === 'rainbow') {
                legendHTML += '<div style="width: 100%; text-align: center; margin-bottom: 10px;"><strong>Rainbow Colors:</strong> Hue varies by result value (0 to m-1)</div>';
                for (let i = 0; i < Math.min(12, m); i++) {
                    const color = getRainbowColor(i, m);
                    legendHTML += `
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${color};"></div>
                            <span>Value ${i}</span>
                        </div>
                    `;
                }
            } else if (colorScheme === 'residueClass') {
                legendHTML += '<div style="width: 100%; text-align: center; margin-bottom: 10px;"><strong>Residue Classes:</strong> Each residue class mod 12 gets a distinct color</div>';
            } else if (colorScheme === 'divisibility') {
                legendHTML += '<div style="width: 100%; text-align: center; margin-bottom: 10px;"><strong>By Divisibility:</strong> Color intensity based on number of divisors</div>';
                legendHTML += `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2ecc71;"></div>
                        <span>Prime/Coprime</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: hsl(180, 70%, 55%);"></div>
                        <span>Few divisors</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: hsl(60, 70%, 55%);"></div>
                        <span>Many divisors</span>
                    </div>
                `;
            } else if (colorScheme === 'zeroDivisors') {
                legendHTML += '<div style="width: 100%; text-align: center; margin-bottom: 10px;"><strong>Zero Divisors Highlighted</strong></div>';
                legendHTML += `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e74c3c;"></div>
                        <span>Zero Divisor</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #3498db;"></div>
                        <span>Not Zero Divisor</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2c3e50;"></div>
                        <span>Zero Element</span>
                    </div>
                `;
            } else if (colorScheme === 'idempotents') {
                legendHTML += '<div style="width: 100%; text-align: center; margin-bottom: 10px;"><strong>Idempotents Highlighted</strong></div>';
                legendHTML += `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f39c12;"></div>
                        <span>Idempotent (a²≡a)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #95a5a6;"></div>
                        <span>Not Idempotent</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #2c3e50;"></div>
                        <span>Zero Element</span>
                    </div>
                `;
            }
            
            // Label type legend
            if (labelType === 'properties') {
                legendHTML += '<div style="width: 100%; margin-top: 20px; text-align: center;"><strong>Label Legend:</strong></div>';
                legendHTML += `
                    <div class="legend-item">
                        <span style="font-weight: bold; color: #2d3748;">U</span>
                        <span>Unit (invertible)</span>
                    </div>
                    <div class="legend-item">
                        <span style="font-weight: bold; color: #2d3748;">Z</span>
                        <span>Zero Divisor</span>
                    </div>
                    <div class="legend-item">
                        <span style="font-weight: bold; color: #2d3748;">I</span>
                        <span>Idempotent</span>
                    </div>
                    <div class="legend-item">
                        <span style="font-weight: bold; color: #2d3748;">0</span>
                        <span>Zero element</span>
                    </div>
                `;
            }
            
            // Label color legend
            if (labelColor === 'byType') {
                legendHTML += '<div style="width: 100%; margin-top: 20px; text-align: center;"><strong>Label Color by Type:</strong></div>';
                legendHTML += `
                    <div class="legend-item">
                        <span style="font-weight: bold; color: #00ff00;">Green</span>
                        <span>Units</span>
                    </div>
                    <div class="legend-item">
                        <span style="font-weight: bold; color: #ff0000;">Red</span>
                        <span>Zero Divisors</span>
                    </div>
                    <div class="legend-item">
                        <span style="font-weight: bold; color: #ffff00;">Yellow</span>
                        <span>Idempotents</span>
                    </div>
                    <div class="legend-item">
                        <span style="font-weight: bold; color: #ffffff;">White</span>
                        <span>Other</span>
                    </div>
                `;
            }
            
            legendContent.innerHTML = legendHTML;
            legendSection.style.display = legendHTML ? 'block' : 'none';
        }

        // Helper function to get contrasting text color
        function getContrastColor(hexColor) {
            // Convert hex/hsl to RGB
            const ctx = document.createElement('canvas').getContext('2d');
            ctx.fillStyle = hexColor;
            const rgb = ctx.fillStyle;
            
            // Extract RGB values
            let r, g, b;
            if (rgb.startsWith('#')) {
                r = parseInt(rgb.substr(1, 2), 16);
                g = parseInt(rgb.substr(3, 2), 16);
                b = parseInt(rgb.substr(5, 2), 16);
            } else if (rgb.startsWith('rgb')) {
                const matches = rgb.match(/\d+/g);
                r = parseInt(matches[0]);
                g = parseInt(matches[1]);
                b = parseInt(matches[2]);
            } else {
                return '#ffffff';
            }
            
            // Calculate luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            return luminance > 0.5 ? '#000000' : '#ffffff';
        }

        function updateStatistics(m, units, zeroDivisors, idempotents, nilpotents, tableType) {
            // Basic stats
            document.getElementById('statModulus').textContent = m;
            document.getElementById('statTotal').textContent = m * m;
            document.getElementById('statUnique').textContent = m;
            document.getElementById('statPhi').textContent = units.length;

            const isIntegral = zeroDivisors.length === 0;
            const isField = isPrime(m);
            document.getElementById('statIntegral').textContent = isIntegral ? 'YES' : 'NO';
            document.getElementById('statField').textContent = isField ? 'YES' : 'NO';

            // Special elements
            document.getElementById('unitsCount').textContent = units.length;
            document.getElementById('unitsList').textContent = `{${units.join(', ')}}`;
            document.getElementById('zeroDivisorsCount').textContent = zeroDivisors.length;
            document.getElementById('zeroDivisorsList').textContent = `{${zeroDivisors.join(', ')}}`;
            document.getElementById('idempotentsCount').textContent = idempotents.length;
            document.getElementById('idempotentsList').textContent = `{${idempotents.join(', ')}}`;
            document.getElementById('nilpotentsCount').textContent = nilpotents.length;
            document.getElementById('nilpotentsList').textContent = nilpotents.length > 0 ? `{${nilpotents.join(', ')}}` : '{}';

            // Structure analysis
            const structureHTML = `
                <div class="structure-item">Modulus m = ${m}</div>
                <div class="structure-item">The ring ℤ/${m}ℤ has ${m} elements: {0, 1, ..., ${m-1}}</div>
                <div class="structure-item">Units (invertible elements): ${units.length} = φ(${m})</div>
                <div class="structure-item">This ring ${zeroDivisors.length > 0 ? 'has ' + zeroDivisors.length + ' zero divisor(s). It is NOT an integral domain.' : 'is an integral domain (no zero divisors).'}</div>
                <div class="structure-item">Idempotent elements (a² ≡ a): ${idempotents.length}</div>
                ${nilpotents.length > 0 ? `<div class="structure-item">Nilpotent elements: ${nilpotents.length}</div>` : ''}
            `;
            document.getElementById('structureContent').innerHTML = structureHTML;

            // Explanation
            const explanationHTML = getExplanation(tableType);
            document.getElementById('explanationContent').innerHTML = explanationHTML;
        }

        function getExplanation(tableType) {
            if (tableType === 'multiplication') {
                return `
                    <p><strong>Multiplication Table:</strong> This table shows all products a × b (mod m) for elements in ℤ/mℤ.</p>
                    <p><strong>Units:</strong> Elements with multiplicative inverses (gcd(a, m) = 1). They form a group (ℤ/mℤ)×.</p>
                    <p><strong>Zero Divisors:</strong> Non-zero elements a where a × b ≡ 0 (mod m) for some non-zero b. These prevent the ring from being an integral domain.</p>
                    <p><strong>Idempotents:</strong> Elements satisfying a² ≡ a (mod m). Always include 0 and 1.</p>
                `;
            } else if (tableType === 'cayley') {
                return `
                    <p><strong>Cayley Table (Units Only):</strong> This restricted multiplication table shows only the units (invertible elements).</p>
                    <p><strong>Group Structure:</strong> The units form a group (ℤ/mℤ)× under multiplication mod m.</p>
                    <p><strong>Order:</strong> The group has φ(m) elements, where φ is Euler's totient function.</p>
                    <p><strong>Closure:</strong> The product of two units is always a unit, so this table is closed.</p>
                `;
            } else {
                return `
                    <p><strong>Addition Table:</strong> This table shows all sums a + b (mod m) for elements in ℤ/mℤ.</p>
                    <p><strong>Group Structure:</strong> (ℤ/mℤ, +) forms an abelian group of order m.</p>
                    <p><strong>Properties:</strong> Every element has an additive inverse. The identity is 0.</p>
                    <p><strong>Symmetry:</strong> The table is symmetric about the main diagonal (commutativity).</p>
                `;
            }
        }

        // Export functions
        function exportCanvas() {
            const canvas = document.getElementById('gridCanvas');
            const currentRes = parseInt(document.getElementById('resolutionSlider').value);
            const highDPI = document.getElementById('highDPI').checked;
            
            // For export, always use maximum quality
            const exportRes = Math.max(3840, currentRes * 2); // At least 4K
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = exportRes;
            exportCanvas.height = exportRes;
            const ctx = exportCanvas.getContext('2d', { alpha: false });
            
            // Scale and draw
            ctx.scale(exportRes / currentRes, exportRes / currentRes);
            ctx.drawImage(canvas, 0, 0);
            
            exportCanvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const m = document.getElementById('modulusInput').value;
                a.href = url;
                a.download = `modular_grid_m${m}_${exportRes}x${exportRes}.png`;
                a.click();
                URL.revokeObjectURL(url);
                
                showInfo('Export Complete', `Exported ${exportRes}×${exportRes} PNG (${(exportRes*exportRes/1000000).toFixed(1)}MP)`);
            });
        }

        function exportData() {
            const m = parseInt(document.getElementById('modulusInput').value);
            const tableType = document.querySelector('input[name="tableType"]:checked').value;
            
            let csv = 'a,b,result,operation\n';
            
            const elements = tableType === 'cayley' ? findUnits(m) : Array.from({ length: m }, (_, i) => i);
            
            for (let i = 0; i < elements.length; i++) {
                for (let j = 0; j < elements.length; j++) {
                    const a = elements[i];
                    const b = elements[j];
                    const result = tableType === 'addition' ? (a + b) % m : (a * b) % m;
                    const op = tableType === 'addition' ? 'addition' : 'multiplication';
                    csv += `${a},${b},${result},${op}\n`;
                }
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `modular_grid_m${m}_data.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize
        window.onload = function() {
            updateVisualization();
        };
    </script>
</body>
    </html>
