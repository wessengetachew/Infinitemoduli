
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modular Arithmetic Explorer - Multi-Canvas Visualization Suite</title>
    <style>
        :root {
            --bg-deep: #0a0e1a;
            --bg-card: #141829;
            --bg-panel: #1a1f35;
            --gold: #FFD700;
            --gold-dim: #B8960A;
            --cyan: #00FFFF;
            --cyan-dim: #008B8B;
            --text-primary: #E8E8E8;
            --text-secondary: #A0A0A0;
            --border: #2a3150;
            --accent-purple: #9F7AEA;
            --accent-green: #48BB78;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 20px;
        }

        .main-container {
            max-width: 2400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: linear-gradient(135deg, var(--bg-card), var(--bg-panel));
            border-radius: 15px;
            border: 2px solid var(--border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--gold), var(--cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.2em;
            margin-top: 10px;
        }

        .author {
            color: var(--gold-dim);
            margin-top: 15px;
            font-style: italic;
            font-size: 1.1em;
        }

        /* Canvas Grid */
        .viz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }

        .canvas-panel {
            background: var(--bg-card);
            border-radius: 12px;
            border: 2px solid var(--border);
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .canvas-panel:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(255, 215, 0, 0.2);
            border-color: var(--gold-dim);
        }

        .panel-header {
            background: linear-gradient(135deg, var(--bg-panel), var(--bg-card));
            padding: 20px;
            border-bottom: 2px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .panel-subtitle {
            color: var(--cyan-dim);
            font-size: 0.9em;
            margin-top: 5px;
        }

        canvas {
            display: block;
            width: 100%;
            height: auto;
            background: var(--bg-deep);
        }

        .canvas-info {
            padding: 15px;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        /* Controls Section */
        .controls-section {
            background: var(--bg-card);
            border-radius: 12px;
            border: 2px solid var(--border);
            padding: 30px;
            margin: 30px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .controls-header {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .section-header {
            font-size: 1.3em;
            color: var(--cyan);
            margin: 25px 0 15px 0;
            font-weight: 600;
        }

        .control-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-item {
            flex: 1;
            min-width: 250px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .control-value {
            color: var(--gold);
            font-family: 'Courier New', monospace;
            font-weight: 700;
            padding: 4px 12px;
            background: var(--bg-panel);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: var(--bg-panel);
            outline: none;
            -webkit-appearance: none;
            border: 1px solid var(--border);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), var(--cyan));
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), var(--cyan));
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            border: none;
        }

        input[type="number"] {
            width: 100%;
            padding: 12px;
            background: var(--bg-panel);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1em;
            transition: all 0.3s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* Radio and Checkbox Styles */
        .radio-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: var(--bg-panel);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option:hover, .checkbox-option:hover {
            border-color: var(--gold-dim);
            background: var(--bg-card);
        }

        .radio-option input:checked + span,
        .checkbox-option input:checked + span {
            color: var(--gold);
            font-weight: 700;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold-dim), var(--gold));
            color: var(--bg-deep);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(255, 215, 0, 0.5);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--cyan-dim), var(--cyan));
            color: var(--bg-deep);
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 255, 255, 0.5);
        }

        /* Preset Grid */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .preset-btn {
            padding: 12px;
            background: var(--bg-panel);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preset-btn:hover {
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-green));
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(159, 122, 234, 0.4);
        }

        /* Info Panel */
        .info-panel {
            background: linear-gradient(135deg, var(--bg-panel), var(--bg-card));
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--border);
            margin: 20px 0;
        }

        .info-title {
            font-size: 1.3em;
            color: var(--gold);
            margin-bottom: 15px;
            font-weight: 700;
        }

        .info-content {
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--bg-panel);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid var(--border);
            text-align: center;
        }

        .stat-label {
            color: var(--cyan);
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .stat-value {
            color: var(--gold);
            font-size: 2em;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .stat-details {
            color: var(--text-secondary);
            font-size: 0.85em;
            margin-top: 8px;
            word-wrap: break-word;
        }

        /* Export Section */
        .export-section {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0;
            padding: 25px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 2px solid var(--border);
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 30px;
            border-top: 2px solid var(--border);
            color: var(--text-secondary);
        }

        footer a {
            color: var(--gold);
            text-decoration: none;
            transition: color 0.3s;
        }

        footer a:hover {
            color: var(--cyan);
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .viz-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 900px) {
            .viz-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
        }

        /* Notification */
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--gold), var(--cyan));
            color: var(--bg-deep);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <header>
            <h1>⟨ Modular Arithmetic Explorer ⟩</h1>
            <div class="subtitle">Multi-Canvas Visualization Suite · Ring Theory · Number Theory</div>
            <div class="author">Wessen Getachew · @7dview</div>
        </header>

        <!-- Multi-Canvas Visualization Grid -->
        <div class="viz-grid">
            <!-- Canvas 1: Main Multiplication Grid -->
            <div class="canvas-panel">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">⊗ Multiplication Table</div>
                        <div class="panel-subtitle">Ring ℤ/mℤ · Color-coded Structure</div>
                    </div>
                </div>
                <canvas id="gridCanvas" width="800" height="800"></canvas>
                <div class="canvas-info" id="gridInfo">
                    Multiplication table visualization with configurable color schemes
                </div>
            </div>

            <!-- Canvas 2: Unit Circle Representation -->
            <div class="canvas-panel">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">○ Unit Circle</div>
                        <div class="panel-subtitle">Elements as Roots of Unity</div>
                    </div>
                </div>
                <canvas id="circleCanvas" width="800" height="800"></canvas>
                <div class="canvas-info" id="circleInfo">
                    Elements mapped to e^(2πik/m) on the unit circle
                </div>
            </div>

            <!-- Canvas 3: GCD Structure -->
            <div class="canvas-panel">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">⊚ GCD Structure</div>
                        <div class="panel-subtitle">Coprimality Network</div>
                    </div>
                </div>
                <canvas id="gcdCanvas" width="800" height="800"></canvas>
                <div class="canvas-info" id="gcdInfo">
                    Visual representation of gcd relationships
                </div>
            </div>

            <!-- Canvas 4: Coprime Density -->
            <div class="canvas-panel">
                <div class="panel-header">
                    <div>
                        <div class="panel-title">◬ Coprime Density</div>
                        <div class="panel-subtitle">φ(m)/m Analysis</div>
                    </div>
                </div>
                <canvas id="densityCanvas" width="800" height="800"></canvas>
                <div class="canvas-info" id="densityInfo">
                    Visualization of Euler's totient function density
                </div>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="controls-section">
            <div class="controls-header">Configuration & Parameters</div>

            <!-- Presets -->
            <div class="section-header">Mathematical Presets</div>
            <div class="preset-grid">
                <button class="preset-btn" onclick="applyPreset('basel')">ζ(2)=π²/6 (m=6)</button>
                <button class="preset-btn" onclick="applyPreset('totient12')">φ(12)=4</button>
                <button class="preset-btn" onclick="applyPreset('prime')">Prime Field (m=17)</button>
                <button class="preset-btn" onclick="applyPreset('highly_composite')">Highly Composite (m=60)</button>
                <button class="preset-btn" onclick="applyPreset('power_of_2')">Power of 2 (m=32)</button>
                <button class="preset-btn" onclick="applyPreset('fibonacci')">Fibonacci Prime (m=89)</button>
                <button class="preset-btn" onclick="applyPreset('mersenne')">Mersenne Prime (m=31)</button>
                <button class="preset-btn" onclick="applyPreset('perfect')">Perfect Number (m=28)</button>
                <button class="preset-btn" onclick="applyPreset('golden')">Golden Ratio (m≈161)</button>
                <button class="preset-btn" onclick="applyPreset('ramanujan')">Ramanujan τ (m=24)</button>
            </div>

            <!-- Modulus Control -->
            <div class="section-header">Modulus Parameter</div>
            <div class="control-row">
                <div class="control-item">
                    <div class="control-label">
                        <span>Modulus (m)</span>
                        <span class="control-value" id="modulusDisplay">12</span>
                    </div>
                    <input type="range" id="modulusSlider" min="2" max="100" value="12" oninput="updateModulus()">
                </div>
                <div class="control-item">
                    <label class="control-label">
                        <span>Direct Input</span>
                    </label>
                    <input type="number" id="modulusInput" min="2" max="500" value="12" onchange="updateModulusFromInput()">
                </div>
            </div>

            <!-- Table Type -->
            <div class="section-header">Table Type</div>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="tableType" value="multiplication" checked onchange="updateVisualization()">
                    <span>Multiplication</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="tableType" value="cayley" onchange="updateVisualization()">
                    <span>Units Only (Cayley)</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="tableType" value="addition" onchange="updateVisualization()">
                    <span>Addition</span>
                </label>
            </div>

            <!-- Color Scheme -->
            <div class="section-header">Color Scheme</div>
            <div class="radio-group">
                <label class="radio-option">
                    <input type="radio" name="colorScheme" value="rainbow" checked onchange="updateVisualization()">
                    <span>Rainbow</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="colorScheme" value="divisibility" onchange="updateVisualization()">
                    <span>Divisibility</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="colorScheme" value="zeroDivisors" onchange="updateVisualization()">
                    <span>Zero Divisors</span>
                </label>
                <label class="radio-option">
                    <input type="radio" name="colorScheme" value="idempotents" onchange="updateVisualization()">
                    <span>Idempotents</span>
                </label>
            </div>

            <!-- Display Options -->
            <div class="section-header">Display Options</div>
            <div class="radio-group">
                <label class="checkbox-option">
                    <input type="checkbox" id="showLabels" checked onchange="updateVisualization()">
                    <span>Show Labels</span>
                </label>
                <label class="checkbox-option">
                    <input type="checkbox" id="showGridLines" onchange="updateVisualization()">
                    <span>Grid Lines</span>
                </label>
                <label class="checkbox-option">
                    <input type="checkbox" id="highlightUnits" onchange="updateVisualization()">
                    <span>Highlight Units</span>
                </label>
            </div>
        </div>

        <!-- Statistics Panel -->
        <div class="info-panel">
            <div class="info-title">Ring Statistics & Properties</div>
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-label">MODULUS</div>
                    <div class="stat-value" id="statModulus">12</div>
                    <div class="stat-details" id="statFactorization">2² × 3</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">UNITS φ(m)</div>
                    <div class="stat-value" id="statPhi">4</div>
                    <div class="stat-details" id="statUnitsList">{1,5,7,11}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ZERO DIVISORS</div>
                    <div class="stat-value" id="statZeroDivisors">7</div>
                    <div class="stat-details" id="statZDList">Non-invertible elements</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">IDEMPOTENTS</div>
                    <div class="stat-value" id="statIdempotents">4</div>
                    <div class="stat-details" id="statIdempList">{0,1,4,9}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">RING TYPE</div>
                    <div class="stat-value" id="statField">NO</div>
                    <div class="stat-details">Field Status</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">DENSITY</div>
                    <div class="stat-value" id="statDensity">0.33</div>
                    <div class="stat-details">φ(m)/m ratio</div>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="export-section">
            <button class="btn btn-primary" onclick="exportWithAnalysis()">Export with Analysis</button>
            <button class="btn btn-primary" onclick="exportAllCanvases()">Export All 4 Canvases</button>
            <button class="btn btn-secondary" onclick="exportCanvas('grid')">Grid Only</button>
            <button class="btn btn-secondary" onclick="exportCanvas('circle')">Circle Only</button>
            <button class="btn btn-secondary" onclick="exportCanvas('gcd')">GCD Only</button>
            <button class="btn btn-secondary" onclick="exportCanvas('density')">Density Only</button>
            <button class="btn btn-secondary" onclick="exportData()">Export CSV Data</button>
        </div>

        <footer>
            <p style="font-size: 1.2em; margin-bottom: 15px;">Interactive Mathematical Visualization Tool</p>
            <p>
                Wessen Getachew | 
                <a href="https://github.com/wessengetachew" target="_blank">GitHub</a> | 
                <a href="https://twitter.com/7dview" target="_blank">@7dview</a>
            </p>
            <p style="margin-top: 15px; color: var(--text-secondary); font-size: 0.9em;">
                Exploring connections between modular arithmetic, ring theory, and geometric representations
            </p>
        </footer>
    </div>

    <script>
        // Mathematical utility functions
        function gcd(a, b) {
            a = Math.abs(a);
            b = Math.abs(b);
            while (b !== 0) {
                let t = b;
                b = a % b;
                a = t;
            }
            return a;
        }

        function euler_phi(n) {
            if (n === 1) return 1;
            let result = n;
            let p = 2;
            let temp = n;
            while (p * p <= temp) {
                if (temp % p === 0) {
                    while (temp % p === 0) temp /= p;
                    result -= result / p;
                }
                p++;
            }
            if (temp > 1) result -= result / temp;
            return Math.round(result);
        }

        function isPrime(n) {
            if (n < 2) return false;
            if (n === 2) return true;
            if (n % 2 === 0) return false;
            for (let i = 3; i * i <= n; i += 2) {
                if (n % i === 0) return false;
            }
            return true;
        }

        function findUnits(m) {
            const units = [];
            for (let a = 1; a < m; a++) {
                if (gcd(a, m) === 1) units.push(a);
            }
            return units;
        }

        function findZeroDivisors(m) {
            const zeroDivisors = new Set();
            for (let a = 1; a < m; a++) {
                if (gcd(a, m) > 1) {
                    zeroDivisors.add(a);
                }
            }
            return Array.from(zeroDivisors).sort((a, b) => a - b);
        }

        function findIdempotents(m) {
            const idempotents = [];
            for (let a = 0; a < m; a++) {
                if ((a * a) % m === a) idempotents.push(a);
            }
            return idempotents;
        }

        function getPrimeFactorization(n) {
            if (n === 1) return '1';
            if (isPrime(n)) return `${n} (prime)`;
            
            const factors = [];
            let temp = n;
            let p = 2;
            
            while (p * p <= temp) {
                let count = 0;
                while (temp % p === 0) {
                    count++;
                    temp /= p;
                }
                if (count > 0) {
                    factors.push(count === 1 ? `${p}` : `${p}^${count}`);
                }
                p++;
            }
            if (temp > 1) factors.push(`${temp}`);
            
            return factors.join(' × ');
        }

        // Color schemes
        function getRainbowColor(value, m) {
            const hue = (value / m) * 360;
            return `hsl(${hue}, 80%, 60%)`;
        }

        function getDivisibilityColor(value, m) {
            if (value === 0) return '#34495e';
            const divisors = [];
            for (let d = 2; d <= m; d++) {
                if (value % d === 0) divisors.push(d);
            }
            if (divisors.length === 0) return '#48BB78';
            const hue = 240 - (divisors.length / m) * 180;
            return `hsl(${hue}, 70%, 55%)`;
        }

        function getZeroDivisorColor(value, m, zeroDivisors) {
            if (value === 0) return '#2c3e50';
            return zeroDivisors.includes(value) ? '#e74c3c' : '#3498db';
        }

        function getIdempotentColor(value, m, idempotents) {
            if (value === 0) return '#2c3e50';
            return idempotents.includes(value) ? '#FFD700' : '#95a5a6';
        }

        // Preset configurations
        function applyPreset(presetName) {
            const presets = {
                'basel': { m: 6, table: 'multiplication', color: 'zeroDivisors', title: 'Basel Problem', msg: 'Related to ζ(2) = π²/6' },
                'totient12': { m: 12, table: 'cayley', color: 'rainbow', title: 'φ(12) = 4', msg: 'Classic totient example' },
                'prime': { m: 17, table: 'multiplication', color: 'rainbow', title: 'Prime Field', msg: 'Field structure, all non-zero elements are units' },
                'highly_composite': { m: 60, table: 'multiplication', color: 'divisibility', title: 'Highly Composite', msg: '60 = 2²×3×5 has many divisors' },
                'power_of_2': { m: 32, table: 'multiplication', color: 'idempotents', title: 'Power of 2', msg: '32 = 2⁵ with special structure' },
                'fibonacci': { m: 89, table: 'cayley', color: 'rainbow', title: 'Fibonacci Prime', msg: 'F₁₁ = 89 is prime' },
                'mersenne': { m: 31, table: 'multiplication', color: 'rainbow', title: 'Mersenne Prime', msg: '31 = 2⁵ - 1' },
                'perfect': { m: 28, table: 'multiplication', color: 'divisibility', title: 'Perfect Number', msg: '28 = 1+2+4+7+14' },
                'golden': { m: 161, table: 'multiplication', color: 'zeroDivisors', title: 'Golden Ratio', msg: '161 ≈ 100φ' },
                'ramanujan': { m: 24, table: 'multiplication', color: 'divisibility', title: 'Ramanujan', msg: 'Related to τ function' }
            };

            const preset = presets[presetName];
            if (!preset) return;

            document.getElementById('modulusInput').value = preset.m;
            document.getElementById('modulusSlider').value = Math.min(preset.m, 100);
            document.getElementById('modulusDisplay').textContent = Math.min(preset.m, 100);
            
            document.querySelector(`input[name="tableType"][value="${preset.table}"]`).checked = true;
            document.querySelector(`input[name="colorScheme"][value="${preset.color}"]`).checked = true;
            
            showNotification(preset.title, preset.msg);
            updateVisualization();
        }

        function showNotification(title, message) {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <h3 style="margin: 0 0 10px 0; font-size: 1.2em;">${title}</h3>
                <p style="margin: 0; line-height: 1.5;">${message}</p>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Update functions
        function updateModulus() {
            const value = document.getElementById('modulusSlider').value;
            document.getElementById('modulusDisplay').textContent = value;
            document.getElementById('modulusInput').value = value;
            updateVisualization();
        }

        function updateModulusFromInput() {
            const value = parseInt(document.getElementById('modulusInput').value);
            if (value >= 2 && value <= 500) {
                document.getElementById('modulusSlider').value = Math.min(value, 100);
                document.getElementById('modulusDisplay').textContent = Math.min(value, 100);
                updateVisualization();
            }
        }

        // Main visualization function
        function updateVisualization() {
            const m = parseInt(document.getElementById('modulusInput').value);
            const tableType = document.querySelector('input[name="tableType"]:checked').value;
            const colorScheme = document.querySelector('input[name="colorScheme"]:checked').value;
            const showLabels = document.getElementById('showLabels').checked;
            const showGridLines = document.getElementById('showGridLines').checked;
            const highlightUnits = document.getElementById('highlightUnits').checked;

            // Get special elements
            const units = findUnits(m);
            const zeroDivisors = findZeroDivisors(m);
            const idempotents = findIdempotents(m);

            // Draw all canvases
            drawGridCanvas(m, tableType, colorScheme, showLabels, showGridLines, units, zeroDivisors, idempotents);
            drawCircleCanvas(m, units, highlightUnits);
            drawGCDCanvas(m);
            drawDensityCanvas(m);

            // Update statistics
            updateStatistics(m, units, zeroDivisors, idempotents);
        }

        // Canvas 1: Main Grid
        function drawGridCanvas(m, tableType, colorScheme, showLabels, showGridLines, units, zeroDivisors, idempotents) {
            const canvas = document.getElementById('gridCanvas');
            const ctx = canvas.getContext('2d');
            const size = tableType === 'cayley' ? units.length : m;
            const cellSize = Math.floor(canvas.width / size);

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const elements = tableType === 'cayley' ? units : Array.from({ length: m }, (_, i) => i);

            for (let i = 0; i < elements.length; i++) {
                for (let j = 0; j < elements.length; j++) {
                    const a = elements[i];
                    const b = elements[j];
                    
                    let value;
                    if (tableType === 'addition') {
                        value = (a + b) % m;
                    } else {
                        value = (a * b) % m;
                    }

                    let color;
                    switch (colorScheme) {
                        case 'rainbow':
                            color = getRainbowColor(value, m);
                            break;
                        case 'divisibility':
                            color = getDivisibilityColor(value, m);
                            break;
                        case 'zeroDivisors':
                            color = getZeroDivisorColor(value, m, zeroDivisors);
                            break;
                        case 'idempotents':
                            color = getIdempotentColor(value, m, idempotents);
                            break;
                    }

                    const x = j * cellSize;
                    const y = i * cellSize;

                    ctx.fillStyle = color;
                    ctx.fillRect(x, y, cellSize - 1, cellSize - 1);

                    if (showGridLines && cellSize > 3) {
                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                        ctx.lineWidth = 0.5;
                        ctx.strokeRect(x, y, cellSize - 1, cellSize - 1);
                    }

                    if (showLabels && cellSize >= 12) {
                        ctx.fillStyle = '#ffffff';
                        ctx.font = `bold ${Math.max(8, cellSize / 3)}px Arial`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                        ctx.shadowBlur = 2;
                        ctx.fillText(value, x + cellSize / 2, y + cellSize / 2);
                        ctx.shadowBlur = 0;
                    }
                }
            }
        }

        // Canvas 2: Unit Circle
        function drawCircleCanvas(m, units, highlightUnits) {
            const canvas = document.getElementById('circleCanvas');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) * 0.8;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw circle
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.stroke();

            // Draw elements
            for (let k = 0; k < m; k++) {
                const angle = (2 * Math.PI * k) / m - Math.PI / 2;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);

                const isUnit = units.includes(k);
                
                ctx.fillStyle = highlightUnits && isUnit ? '#FFD700' : '#00FFFF';
                ctx.beginPath();
                ctx.arc(x, y, isUnit ? 6 : 4, 0, 2 * Math.PI);
                ctx.fill();

                // Label
                const labelRadius = radius * 1.15;
                const labelX = centerX + labelRadius * Math.cos(angle);
                const labelY = centerY + labelRadius * Math.sin(angle);
                
                ctx.fillStyle = isUnit ? '#FFD700' : '#00FFFF';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(k, labelX, labelY);
            }

            // Center
            ctx.fillStyle = '#FFD700';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 4, 0, 2 * Math.PI);
            ctx.fill();
        }

        // Canvas 3: GCD Structure
        function drawGCDCanvas(m) {
            const canvas = document.getElementById('gcdCanvas');
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw rings for each gcd value
            const maxGCD = Math.floor(m / 2);
            for (let g = 1; g <= maxGCD; g++) {
                const radius = (g / maxGCD) * Math.min(centerX, centerY) * 0.9;
                const hue = (g / maxGCD) * 360;
                
                ctx.strokeStyle = `hsl(${hue}, 70%, 60%)`;
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // Plot points
            for (let a = 1; a < m; a++) {
                for (let b = a + 1; b < m; b++) {
                    const g = gcd(a, b);
                    if (g > 1) {
                        const angle1 = (2 * Math.PI * a) / m - Math.PI / 2;
                        const angle2 = (2 * Math.PI * b) / m - Math.PI / 2;
                        const radius = (g / maxGCD) * Math.min(centerX, centerY) * 0.9;
                        
                        const x1 = centerX + radius * Math.cos(angle1);
                        const y1 = centerY + radius * Math.sin(angle1);
                        const x2 = centerX + radius * Math.cos(angle2);
                        const y2 = centerY + radius * Math.sin(angle2);
                        
                        const hue = (g / maxGCD) * 360;
                        ctx.strokeStyle = `hsla(${hue}, 70%, 60%, 0.3)`;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                        ctx.stroke();
                    }
                }
            }
        }

        // Canvas 4: Coprime Density
        function drawDensityCanvas(m) {
            const canvas = document.getElementById('densityCanvas');
            const ctx = canvas.getContext('2d');

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Plot density for n = 2 to m
            const padding = 60;
            const graphWidth = canvas.width - 2 * padding;
            const graphHeight = canvas.height - 2 * padding;

            // Axes
            ctx.strokeStyle = '#FFD700';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            ctx.stroke();

            // Plot points
            for (let n = 2; n <= m; n++) {
                const phi = euler_phi(n);
                const density = phi / n;
                const x = padding + (n / m) * graphWidth;
                const y = canvas.height - padding - density * graphHeight;

                ctx.fillStyle = n === m ? '#FFD700' : '#00FFFF';
                ctx.beginPath();
                ctx.arc(x, y, n === m ? 6 : 3, 0, 2 * Math.PI);
                ctx.fill();
            }

            // Reference line for 6/π²
            const sixOverPiSquared = 6 / (Math.PI * Math.PI);
            const refY = canvas.height - padding - sixOverPiSquared * graphHeight;
            ctx.strokeStyle = '#9F7AEA';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            ctx.moveTo(padding, refY);
            ctx.lineTo(canvas.width - padding, refY);
            ctx.stroke();
            ctx.setLineDash([]);

            // Labels
            ctx.fillStyle = '#FFD700';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('φ(n)/n', padding / 2, canvas.height / 2);
            ctx.fillText('n', canvas.width / 2, canvas.height - padding / 2);
            
            ctx.fillStyle = '#9F7AEA';
            ctx.font = '14px Arial';
            ctx.textAlign = 'right';
            ctx.fillText('6/π² ≈ 0.608', canvas.width - padding - 10, refY - 10);
        }

        // Update statistics
        function updateStatistics(m, units, zeroDivisors, idempotents) {
            document.getElementById('statModulus').textContent = m;
            document.getElementById('statFactorization').textContent = getPrimeFactorization(m);
            
            document.getElementById('statPhi').textContent = units.length;
            const unitsDisplay = units.length <= 20 ? `{${units.join(',')}}` : `{${units.slice(0, 20).join(',')}, ...}`;
            document.getElementById('statUnitsList').textContent = unitsDisplay;
            
            document.getElementById('statZeroDivisors').textContent = zeroDivisors.length;
            const zdDisplay = zeroDivisors.length <= 20 ? `{${zeroDivisors.join(',')}}` : `{${zeroDivisors.slice(0, 20).join(',')}, ...}`;
            document.getElementById('statZDList').textContent = zdDisplay;
            
            document.getElementById('statIdempotents').textContent = idempotents.length;
            const idDisplay = idempotents.length <= 20 ? `{${idempotents.join(',')}}` : `{${idempotents.slice(0, 20).join(',')}, ...}`;
            document.getElementById('statIdempList').textContent = idDisplay;
            
            document.getElementById('statField').textContent = isPrime(m) ? 'YES' : 'NO';
            document.getElementById('statDensity').textContent = (units.length / m).toFixed(3);
        }

        // Export functions
        function exportCanvas(canvasId) {
            const canvasMap = {
                'grid': 'gridCanvas',
                'circle': 'circleCanvas',
                'gcd': 'gcdCanvas',
                'density': 'densityCanvas'
            };
            
            const canvas = document.getElementById(canvasMap[canvasId]);
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = 3840;
            exportCanvas.height = 3840;
            const ctx = exportCanvas.getContext('2d');
            
            ctx.scale(3840 / 800, 3840 / 800);
            ctx.drawImage(canvas, 0, 0);
            
            exportCanvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `modular_${canvasId}_m${document.getElementById('modulusInput').value}.png`;
                a.click();
                URL.revokeObjectURL(url);
            });
            
            showNotification('Export Complete', `${canvasId.charAt(0).toUpperCase() + canvasId.slice(1)} canvas exported at 4K resolution`);
        }

        function exportAllCanvases() {
            const canvases = ['gridCanvas', 'circleCanvas', 'gcdCanvas', 'densityCanvas'];
            const m = document.getElementById('modulusInput').value;
            
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = 3840 * 2;
            exportCanvas.height = 3840 * 2;
            const ctx = exportCanvas.getContext('2d');
            
            ctx.fillStyle = '#0a0e1a';
            ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
            
            canvases.forEach((id, idx) => {
                const canvas = document.getElementById(id);
                const col = idx % 2;
                const row = Math.floor(idx / 2);
                const x = col * 3840;
                const y = row * 3840;
                
                ctx.save();
                ctx.translate(x, y);
                ctx.scale(3840 / 800, 3840 / 800);
                ctx.drawImage(canvas, 0, 0);
                ctx.restore();
            });
            
            exportCanvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `modular_all_4_canvases_m${m}.png`;
                a.click();
                URL.revokeObjectURL(url);
            });
            
            showNotification('Export Complete', 'All 4 canvases exported in 2×2 grid at 4K resolution');
        }

        function exportWithAnalysis() {
            // Implementation similar to previous version
            showNotification('Coming Soon', 'Annotated export with analysis panel');
        }

        function exportData() {
            const m = parseInt(document.getElementById('modulusInput').value);
            const tableType = document.querySelector('input[name="tableType"]:checked').value;
            
            let csv = 'a,b,result,operation\n';
            const elements = tableType === 'cayley' ? findUnits(m) : Array.from({ length: m }, (_, i) => i);
            
            for (let i = 0; i < elements.length; i++) {
                for (let j = 0; j < elements.length; j++) {
                    const a = elements[i];
                    const b = elements[j];
                    const result = tableType === 'addition' ? (a + b) % m : (a * b) % m;
                    const op = tableType === 'addition' ? 'addition' : 'multiplication';
                    csv += `${a},${b},${result},${op}\n`;
                }
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `modular_data_m${m}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Export Complete', 'CSV data file exported');
        }

        // Initialize
        window.onload = function() {
            updateVisualization();
        };
    </script>
</body>
</html>
